<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windturbine Visualisatie - Hoeker en GarstenPolder</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .leaflet-popup-content {
            margin: 8px;
        }
    </style>
</head>
<body>
    <div class="w-full h-screen flex flex-col bg-gray-100">
        <!-- Header -->
        <div class="bg-blue-900 text-white p-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Windturbine Visualisatie - Hoeker en GarstenPolder</h1>
                <p class="text-sm mt-1">Gebied tussen Vecht en Amsterdam-Rijnkanaal</p>
            </div>
            <button 
                id="exportPdfBtn" 
                class="bg-white text-blue-900 px-4 py-2 rounded hover:bg-gray-100 font-medium"
            >
                üìÑ Export PDF
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <div class="w-80 bg-gray-50 p-4 overflow-y-auto">
                
                <!-- Turbine toevoegen -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-semibold mb-2">Turbine plaatsen</h3>
                    <select id="turbineType" class="w-full border rounded px-2 py-1 mb-2">
                        <option value="0">Klein (3 MW, 150m tip) - üü¢</option>
                        <option value="1">Middelgroot (4.5 MW, 200m tip) - üü†</option>
                        <option value="2">Groot (6 MW, 250m tip) - üî¥</option>
                    </select>
                    <button id="addModeBtn" class="w-full px-4 py-2 rounded font-medium bg-green-600 text-white hover:bg-green-700">
                        Klik op kaart om turbine te plaatsen
                    </button>
                    <p id="addModeText" class="text-sm text-gray-600 mt-2 hidden">
                        Klik op de kaart om een turbine te plaatsen
                    </p>
                </div>

                <!-- Afstandscirkels -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-semibold mb-2">Afstandscirkels</h3>
                    <label class="flex items-center mb-2 cursor-pointer">
                        <input type="checkbox" id="zone500" checked class="mr-2">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #ef4444; opacity: 0.5"></span>
                        <span>500m</span>
                    </label>
                    <label class="flex items-center mb-2 cursor-pointer">
                        <input type="checkbox" id="zone1000" checked class="mr-2">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #f97316; opacity: 0.5"></span>
                        <span>1km</span>
                    </label>
                    <label class="flex items-center mb-2 cursor-pointer">
                        <input type="checkbox" id="zone1500" checked class="mr-2">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #eab308; opacity: 0.5"></span>
                        <span>1.5km</span>
                    </label>
                    <label class="flex items-center mb-2 cursor-pointer">
                        <input type="checkbox" id="zone2000" class="mr-2">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #84cc16; opacity: 0.5"></span>
                        <span>2km</span>
                    </label>
                </div>

                <!-- Minimumafstand tussen turbines -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-semibold mb-2">Minimumafstand turbines</h3>
                    <label class="flex items-center mb-2 cursor-pointer">
                        <input type="checkbox" id="showMinDistance" checked class="mr-2">
                        <span>Toon minimumafstand</span>
                    </label>
                    <div class="mt-2">
                        <label class="text-sm text-gray-600">Afstand (meters):</label>
                        <input 
                            type="range" 
                            id="minDistanceSlider" 
                            min="400" 
                            max="1500" 
                            value="800" 
                            step="50"
                            class="w-full"
                        />
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>400m</span>
                            <span id="minDistanceValue" class="font-semibold">800m</span>
                            <span>1500m</span>
                        </div>
                    </div>
                </div>

                <!-- Adres zoeken -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-semibold mb-2">Zoek adres</h3>
                    <div class="flex gap-2 mb-2">
                        <input
                            type="text"
                            id="postcode"
                            placeholder="Postcode"
                            class="border rounded px-2 py-1 w-32"
                        />
                        <input
                            type="text"
                            id="huisnummer"
                            placeholder="Huisnr"
                            class="border rounded px-2 py-1 w-20"
                        />
                        <button
                            id="searchBtn"
                            class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700"
                        >
                            Zoek
                        </button>
                    </div>
                    <p id="searchError" class="text-red-600 text-sm hidden"></p>
                </div>

                <!-- Adres analyse -->
                <div id="addressAnalysis" class="bg-white p-4 rounded-lg shadow-md mb-4 hidden">
                    <h3 class="font-semibold mb-2">Analyse adres</h3>
                    <p id="addressName" class="text-sm mb-1 font-semibold"></p>
                    <p id="addressDistance" class="text-sm mb-1"></p>
                    <p id="addressZone" class="text-sm text-gray-600"></p>
                </div>

                <!-- Statistieken -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-semibold mb-2">Woningen in hindergebied</h3>
                    
                    <!-- CSV Upload -->
                    <div class="mb-3 pb-3 border-b">
                        <label class="text-sm font-semibold text-gray-700 mb-1 block">Adressenbestand uploaden (optioneel)</label>
                        <input 
                            type="file" 
                            id="csvUpload" 
                            accept=".csv"
                            class="w-full text-xs"
                        />
                        <p class="text-xs text-gray-500 mt-1">CSV van adressen_ophalen.py of formaat: adres,postcode,...,lat,lng</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-sm text-gray-600">Afstand voor analyse:</label>
                        <input 
                            type="range" 
                            id="hinderDistanceSlider" 
                            min="250" 
                            max="2000" 
                            value="1000" 
                            step="50"
                            class="w-full"
                        />
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>250m</span>
                            <span id="hinderDistanceValue" class="font-semibold">1000m</span>
                            <span>2000m</span>
                        </div>
                    </div>
                    <button 
                        id="analyzeBtn" 
                        class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 mb-2"
                    >
                        üîç Analyseer woningen
                    </button>
                    <div id="statsResults" class="text-sm hidden">
                        <div class="border-t pt-2 mt-2">
                            <p class="font-semibold mb-1">Resultaten:</p>
                            <div id="statsContent"></div>
                            <button 
                                id="exportAddressesBtn" 
                                class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs mt-2"
                            >
                                üìã Export adressenlijst
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Geplaatste turbines -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-semibold mb-2">
                        Geplaatste turbines (<span id="turbineCount">0</span>)
                    </h3>
                    <div id="turbineList" class="space-y-2">
                        <p class="text-sm text-gray-500">Nog geen turbines geplaatst</p>
                    </div>
                </div>

                <!-- Configuraties opslaan/laden -->
                <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                    <h3 class="font-semibold mb-2">Configuraties</h3>
                    <div class="mb-3">
                        <input 
                            type="text" 
                            id="configName" 
                            placeholder="Naam configuratie..." 
                            class="w-full border rounded px-2 py-1 mb-2"
                        />
                        <button 
                            id="saveConfigBtn" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
                        >
                            üíæ Huidige configuratie opslaan
                        </button>
                    </div>
                    <div id="configList" class="space-y-2">
                        <p class="text-sm text-gray-500">Nog geen configuraties opgeslagen</p>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="flex-1 relative">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Turbine types
        const turbineTypes = [
            { name: 'Klein (3 MW, 150m tip)', hubHeight: 100, rotorDiameter: 100, power: 3 },
            { name: 'Middelgroot (4.5 MW, 200m tip)', hubHeight: 120, rotorDiameter: 160, power: 4.5 },
            { name: 'Groot (6 MW, 250m tip)', hubHeight: 150, rotorDiameter: 200, power: 6 },
        ];

        const distanceZones = [
            { distance: 500, color: '#ef4444', label: '500m', id: 'zone500' },
            { distance: 1000, color: '#f97316', label: '1km', id: 'zone1000' },
            { distance: 1500, color: '#eab308', label: '1.5km', id: 'zone1500' },
            { distance: 2000, color: '#84cc16', label: '2km', id: 'zone2000' },
        ];

        // Minimum distance between turbines (in meters)
        let minimumTurbineDistance = 800; // Default 800m (roughly 4x rotor diameter for large turbines)

        // Hinder distance for address analysis
        let hinderDistance = 1000;
        let affectedAddresses = [];
        let uploadedAddresses = [];

        // Saved configurations
        let savedConfigurations = [];
        
        // Load configurations from localStorage
        try {
            const stored = localStorage.getItem('windturbineConfigs');
            console.log('Loaded from localStorage:', stored);
            if (stored) {
                savedConfigurations = JSON.parse(stored);
                console.log('Parsed configurations:', savedConfigurations);
            }
        } catch (error) {
            console.error('Error loading configurations:', error);
            savedConfigurations = [];
        }

        // State
        let turbines = [];
        let isAddMode = false;
        let searchedAddressMarker = null;
        let searchedAddress = null;
        let turbineCircles = [];

        // Initialize map
        const map = L.map('map').setView([52.235, 5.05], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Custom turbine icons - different colors for each type
        function createTurbineIcon(typeIndex) {
            const colors = [
                { fill: '#10b981', name: 'Groen' },      // Klein - groen
                { fill: '#f59e0b', name: 'Oranje' },     // Middelgroot - oranje  
                { fill: '#ef4444', name: 'Rood' }        // Groot - rood
            ];
            const color = colors[typeIndex];
            
            return L.divIcon({
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36">
                    <circle cx="12" cy="12" r="11" fill="${color.fill}" opacity="0.9"/>
                    <path d="M12 2 L12 22 M12 12 L2 7 M12 12 L22 7 M12 12 L17 22" 
                          stroke="white" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="2" fill="white"/>
                </svg>`,
                className: '',
                iconSize: [36, 36],
                iconAnchor: [18, 18],
                popupAnchor: [0, -18]
            });
        }

        // Add turbine mode toggle
        document.getElementById('addModeBtn').addEventListener('click', function() {
            isAddMode = !isAddMode;
            const btn = this;
            const text = document.getElementById('addModeText');
            
            if (isAddMode) {
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = 'Annuleren';
                text.classList.remove('hidden');
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.textContent = 'Klik op kaart om turbine te plaatsen';
                text.classList.add('hidden');
                map.getContainer().style.cursor = '';
            }
        });

        // Map click handler
        map.on('click', function(e) {
            if (isAddMode) {
                const typeIndex = parseInt(document.getElementById('turbineType').value);
                addTurbine(e.latlng, turbineTypes[typeIndex]);
                isAddMode = false;
                document.getElementById('addModeBtn').click(); // Toggle off
            }
        });

        // Add turbine function
        function addTurbine(latlng, type) {
            const turbineId = Date.now();
            const typeIndex = turbineTypes.indexOf(type);
            
            const marker = L.marker(latlng, { 
                icon: createTurbineIcon(typeIndex),
                draggable: true  // Make marker draggable
            }).addTo(map);
            
            marker.bindPopup(`
                <div class="text-sm">
                    <p class="font-semibold">${type.name}</p>
                    <p>Ashoogte: ${type.hubHeight}m</p>
                    <p>Rotordiameter: ${type.rotorDiameter}m</p>
                    <p>Vermogen: ${type.power} MW</p>
                    <p class="text-xs text-gray-600 mt-1">
                        Tiphoogte: ${type.hubHeight + type.rotorDiameter/2}m
                    </p>
                    <p class="text-xs text-blue-600 mt-2">
                        üí° Sleep de turbine om te verplaatsen
                    </p>
                </div>
            `);

            // Create distance zones
            const circles = [];
            distanceZones.forEach((zone, idx) => {
                const circle = L.circle(latlng, {
                    radius: zone.distance,
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: 0.1,
                    weight: 2,
                }).addTo(map);
                
                if (!document.getElementById(zone.id).checked) {
                    circle.remove();
                }
                circles.push({ circle, zoneId: zone.id });
            });

            // Create minimum distance circle (between turbines)
            const minDistCircle = L.circle(latlng, {
                radius: minimumTurbineDistance,
                color: '#8b5cf6',
                fillColor: '#8b5cf6',
                fillOpacity: 0.15,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            
            if (!document.getElementById('showMinDistance').checked) {
                minDistCircle.remove();
            }

            const turbineData = {
                id: turbineId,
                marker,
                circles,
                minDistCircle,
                type,
                typeIndex,
                latlng: { lat: latlng.lat, lng: latlng.lng }
            };

            // Handle drag events
            marker.on('drag', function(e) {
                const newLatLng = e.target.getLatLng();
                
                // Update all circles
                circles.forEach(c => c.circle.setLatLng(newLatLng));
                minDistCircle.setLatLng(newLatLng);
                
                // Check for conflicts with other turbines
                checkTurbineConflicts(turbineData, newLatLng);
            });

            marker.on('dragend', function(e) {
                const newLatLng = e.target.getLatLng();
                turbineData.latlng = { lat: newLatLng.lat, lng: newLatLng.lng };
                updateAddressAnalysis();
            });

            turbines.push(turbineData);

            updateTurbineList();
            updateAddressAnalysis();
            
            // Check initial conflicts
            checkTurbineConflicts(turbineData, latlng);
        }

        // Remove turbine function
        function removeTurbine(id) {
            const turbine = turbines.find(t => t.id === id);
            if (turbine) {
                turbine.marker.remove();
                turbine.circles.forEach(c => c.circle.remove());
                turbine.minDistCircle.remove();
                turbines = turbines.filter(t => t.id !== id);
                updateTurbineList();
                updateAddressAnalysis();
                
                // Recheck all turbines for conflicts
                turbines.forEach(t => checkTurbineConflicts(t, t.marker.getLatLng()));
            }
        }

        // Check if turbine conflicts with others (too close)
        function checkTurbineConflicts(currentTurbine, currentLatLng) {
            let hasConflict = false;
            
            turbines.forEach(turbine => {
                if (turbine.id === currentTurbine.id) return;
                
                const distance = calculateDistance(
                    { lat: currentLatLng.lat, lng: currentLatLng.lng },
                    turbine.latlng
                );
                
                if (distance < minimumTurbineDistance) {
                    hasConflict = true;
                    // Highlight both turbines in conflict
                    turbine.minDistCircle.setStyle({
                        color: '#dc2626',
                        fillColor: '#dc2626',
                        fillOpacity: 0.25
                    });
                } else {
                    // Reset to normal color if no conflict
                    turbine.minDistCircle.setStyle({
                        color: '#8b5cf6',
                        fillColor: '#8b5cf6',
                        fillOpacity: 0.15
                    });
                }
            });
            
            // Update current turbine's circle
            if (currentTurbine.minDistCircle) {
                currentTurbine.minDistCircle.setStyle({
                    color: hasConflict ? '#dc2626' : '#8b5cf6',
                    fillColor: hasConflict ? '#dc2626' : '#8b5cf6',
                    fillOpacity: hasConflict ? 0.25 : 0.15
                });
            }
            
            return hasConflict;
        }

        // Update turbine list
        function updateTurbineList() {
            const listDiv = document.getElementById('turbineList');
            const countSpan = document.getElementById('turbineCount');
            const colorIndicators = ['üü¢', 'üü†', 'üî¥'];
            
            countSpan.textContent = turbines.length;

            if (turbines.length === 0) {
                listDiv.innerHTML = '<p class="text-sm text-gray-500">Nog geen turbines geplaatst</p>';
            } else {
                listDiv.innerHTML = turbines.map((turbine, idx) => `
                    <div class="flex justify-between items-start text-sm border-b pb-2">
                        <div>
                            <p class="font-medium">${colorIndicators[turbine.typeIndex]} Turbine ${idx + 1}</p>
                            <p class="text-xs text-gray-600">${turbine.type.name}</p>
                        </div>
                        <button onclick="removeTurbine(${turbine.id})" class="text-red-600 hover:text-red-800 text-xs">
                            Verwijder
                        </button>
                    </div>
                `).join('');
            }
        }

        // Zone checkboxes
        distanceZones.forEach(zone => {
            document.getElementById(zone.id).addEventListener('change', function() {
                const isChecked = this.checked;
                turbines.forEach(turbine => {
                    const circleObj = turbine.circles.find(c => c.zoneId === zone.id);
                    if (circleObj) {
                        if (isChecked) {
                            circleObj.circle.addTo(map);
                        } else {
                            circleObj.circle.remove();
                        }
                    }
                });
            });
        });

        // Minimum distance checkbox
        document.getElementById('showMinDistance').addEventListener('change', function() {
            const isChecked = this.checked;
            turbines.forEach(turbine => {
                if (isChecked) {
                    turbine.minDistCircle.addTo(map);
                } else {
                    turbine.minDistCircle.remove();
                }
            });
        });

        // Minimum distance slider
        document.getElementById('minDistanceSlider').addEventListener('input', function() {
            minimumTurbineDistance = parseInt(this.value);
            document.getElementById('minDistanceValue').textContent = minimumTurbineDistance + 'm';
            
            // Update all minimum distance circles
            turbines.forEach(turbine => {
                turbine.minDistCircle.setRadius(minimumTurbineDistance);
                // Recheck conflicts
                checkTurbineConflicts(turbine, turbine.marker.getLatLng());
            });
        });

        // Save configuration
        document.getElementById('saveConfigBtn').addEventListener('click', function() {
            const nameInput = document.getElementById('configName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Vul een naam in voor de configuratie');
                return;
            }
            
            if (turbines.length === 0) {
                alert('Plaats eerst turbines voordat je een configuratie opslaat');
                return;
            }
            
            const config = {
                id: Date.now(),
                name: name,
                timestamp: new Date().toISOString(),
                turbines: turbines.map(t => ({
                    latlng: t.latlng,
                    typeIndex: t.typeIndex,
                    type: t.type
                })),
                minimumDistance: minimumTurbineDistance
            };
            
            savedConfigurations.push(config);
            localStorage.setItem('windturbineConfigs', JSON.stringify(savedConfigurations));
            
            nameInput.value = '';
            updateConfigList();
            
            alert(`Configuratie "${name}" opgeslagen!`);
        });

        // Load configuration
        function loadConfiguration(configId) {
            const config = savedConfigurations.find(c => c.id === configId);
            if (!config) return;
            
            // Clear current turbines
            turbines.forEach(t => {
                t.marker.remove();
                t.circles.forEach(c => c.circle.remove());
                t.minDistCircle.remove();
            });
            turbines = [];
            
            // Set minimum distance
            minimumTurbineDistance = config.minimumDistance || 800;
            document.getElementById('minDistanceSlider').value = minimumTurbineDistance;
            document.getElementById('minDistanceValue').textContent = minimumTurbineDistance + 'm';
            
            // Load turbines
            config.turbines.forEach(turbineData => {
                const latlng = L.latLng(turbineData.latlng.lat, turbineData.latlng.lng);
                // Use typeIndex to get the correct type from turbineTypes array
                const type = turbineTypes[turbineData.typeIndex];
                addTurbine(latlng, type);
            });
            
            // Zoom to fit all turbines
            if (turbines.length > 0) {
                const bounds = L.latLngBounds(turbines.map(t => t.marker.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Delete configuration
        function deleteConfiguration(configId) {
            if (!confirm('Weet je zeker dat je deze configuratie wilt verwijderen?')) {
                return;
            }
            
            savedConfigurations = savedConfigurations.filter(c => c.id !== configId);
            localStorage.setItem('windturbineConfigs', JSON.stringify(savedConfigurations));
            updateConfigList();
        }

        // Update configuration list
        function updateConfigList() {
            const listDiv = document.getElementById('configList');
            
            console.log('Updating config list, total configs:', savedConfigurations.length);
            
            if (savedConfigurations.length === 0) {
                listDiv.innerHTML = '<p class="text-sm text-gray-500">Nog geen configuraties opgeslagen</p>';
            } else {
                listDiv.innerHTML = savedConfigurations.map(config => {
                    const date = new Date(config.timestamp);
                    const dateStr = date.toLocaleDateString('nl-NL', { 
                        day: 'numeric', 
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="border rounded p-2 text-sm">
                            <div class="flex justify-between items-start mb-1">
                                <p class="font-medium">${config.name}</p>
                                <button 
                                    onclick="deleteConfiguration(${config.id})" 
                                    class="text-red-600 hover:text-red-800 text-xs"
                                    title="Verwijderen"
                                >
                                    ‚úï
                                </button>
                            </div>
                            <p class="text-xs text-gray-600 mb-2">
                                ${config.turbines.length} turbine${config.turbines.length !== 1 ? 's' : ''} ‚Ä¢ ${dateStr}
                            </p>
                            <div class="flex gap-1">
                                <button 
                                    onclick="loadConfiguration(${config.id})" 
                                    class="flex-1 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs"
                                >
                                    üìÇ Laden
                                </button>
                                <button 
                                    onclick="exportConfiguration(${config.id})" 
                                    class="flex-1 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs"
                                    title="Download als deelbaar HTML bestand"
                                >
                                    ‚¨áÔ∏è Export
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Export configuration as standalone HTML file
        function exportConfiguration(configId) {
            const config = savedConfigurations.find(c => c.id === configId);
            if (!config) return;
            
            // Get the current HTML content
            const htmlContent = document.documentElement.outerHTML;
            
            // Create a modified version with the configuration pre-loaded
            const modifiedHtml = htmlContent.replace(
                'let savedConfigurations = [];',
                `let savedConfigurations = [];
        
        // Auto-load configuration on page load
        window.addEventListener('load', function() {
            const preloadedConfig = ${JSON.stringify(config)};
            
            // Set minimum distance
            minimumTurbineDistance = preloadedConfig.minimumDistance || 800;
            document.getElementById('minDistanceSlider').value = minimumTurbineDistance;
            document.getElementById('minDistanceValue').textContent = minimumTurbineDistance + 'm';
            
            // Load turbines
            preloadedConfig.turbines.forEach(turbineData => {
                const latlng = L.latLng(turbineData.latlng.lat, turbineData.latlng.lng);
                const type = turbineTypes[turbineData.typeIndex];
                addTurbine(latlng, type);
            });
            
            // Zoom to fit all turbines
            if (turbines.length > 0) {
                const bounds = L.latLngBounds(turbines.map(t => t.marker.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Update header to show config name
            const header = document.querySelector('h1');
            if (header) {
                header.textContent = 'Windturbine Visualisatie - ${config.name}';
            }
        });`
            );
            
            // Create blob and download
            const blob = new Blob([modifiedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `windturbine-${config.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Configuratie "${config.name}" gedownload!\n\nJe kunt dit HTML-bestand nu delen met anderen.\nZij zien automatisch deze configuratie bij het openen.`);
        }

        // Initialize config list on load
        document.addEventListener('DOMContentLoaded', function() {
            updateConfigList();
        });
        
        // Also call it immediately in case DOMContentLoaded already fired
        updateConfigList();

        // Hinder distance slider
        document.getElementById('hinderDistanceSlider').addEventListener('input', function() {
            hinderDistance = parseInt(this.value);
            document.getElementById('hinderDistanceValue').textContent = hinderDistance + 'm';
        });

        // CSV upload handler
        document.getElementById('csvUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        });
        
        // Parse a single CSV line, respecting quoted fields
        function parseCSVLine(line) {
            const fields = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i++; // skip escaped quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (ch === ',' && !inQuotes) {
                    fields.push(current.trim());
                    current = '';
                } else {
                    current += ch;
                }
            }
            fields.push(current.trim());
            return fields;
        }

        // Parse CSV file ‚Äî auto-detects columns from header row
        function parseCSV(csv) {
            const lines = csv.split('\n');
            uploadedAddresses = [];
            
            if (lines.length < 2) {
                alert('CSV bestand is leeg of heeft geen data.');
                return;
            }
            
            // Parse header to detect column indices
            const header = parseCSVLine(lines[0]);
            const colMap = {};
            header.forEach((col, idx) => {
                colMap[col.toLowerCase()] = idx;
            });
            
            // Find required column indices (support multiple naming conventions)
            const adresIdx = colMap['adres'] ?? colMap['address'] ?? colMap['weergavenaam'] ?? 0;
            const postcodeIdx = colMap['postcode'] ?? 1;
            const latIdx = colMap['lat'] ?? colMap['latitude'] ?? null;
            const lngIdx = colMap['lng'] ?? colMap['lon'] ?? colMap['longitude'] ?? null;
            const huisnummerIdx = colMap['huisnummer'] ?? colMap['huis_nlt'] ?? null;
            const woonplaatsIdx = colMap['woonplaats'] ?? colMap['woonplaatsnaam'] ?? null;
            
            if (latIdx === null || lngIdx === null) {
                alert('CSV bestand mist lat/lng kolommen.\nZorg dat de header "lat" en "lng" kolommen bevat.');
                return;
            }
            
            const objecttypeIdx = colMap['objecttype'] ?? null;
            
            console.log('CSV kolommen gedetecteerd:', { adresIdx, postcodeIdx, latIdx, lngIdx, huisnummerIdx, woonplaatsIdx, objecttypeIdx });
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const fields = parseCSVLine(line);
                
                const lat = parseFloat(fields[latIdx]);
                const lng = parseFloat(fields[lngIdx]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    uploadedAddresses.push({
                        address: fields[adresIdx] || '',
                        postcode: fields[postcodeIdx] || '',
                        huisnummer: huisnummerIdx !== null ? (fields[huisnummerIdx] || '') : '',
                        woonplaats: woonplaatsIdx !== null ? (fields[woonplaatsIdx] || '') : '',
                        objecttype: objecttypeIdx !== null ? (fields[objecttypeIdx] || 'verblijfsobject') : 'verblijfsobject',
                        lat,
                        lng
                    });
                }
            }
            
            const ligplaatsen = uploadedAddresses.filter(a => a.objecttype === 'ligplaats').length;
            const standplaatsen = uploadedAddresses.filter(a => a.objecttype === 'standplaats').length;
            let summary = `${uploadedAddresses.length} adressen succesvol geladen!`;
            if (ligplaatsen > 0 || standplaatsen > 0) {
                const parts = [];
                if (ligplaatsen > 0) parts.push(`${ligplaatsen} ligplaatsen (woonboten)`);
                if (standplaatsen > 0) parts.push(`${standplaatsen} standplaatsen`);
                summary += `\nWaarvan ${parts.join(', ')}.`;
            }
            console.log(`${uploadedAddresses.length} adressen geladen uit CSV (${ligplaatsen} ligplaatsen, ${standplaatsen} standplaatsen)`);
            alert(summary);
        }

        // Analyze addresses button
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            if (turbines.length === 0) {
                alert('Plaats eerst turbines voordat je een analyse uitvoert');
                return;
            }

            if (uploadedAddresses.length === 0) {
                alert('Upload eerst een CSV bestand met adressen.\n\nGebruik het bestand gegenereerd door adressen_ophalen.py\nof een CSV met kolommen: adres,postcode,...,lat,lng');
                return;
            }

            const btn = this;
            btn.textContent = 'Bezig met analyseren...';
            btn.disabled = true;

            try {
                analyzeAffectedAddresses();
            } catch (error) {
                console.error('Analyse fout:', error);
                alert('Fout bij analyseren: ' + error.message);
            } finally {
                btn.textContent = 'üîç Analyseer woningen';
                btn.disabled = false;
            }
        });

        // Export addresses button
        document.getElementById('exportAddressesBtn').addEventListener('click', function() {
            exportAddressList();
        });

        // Export PDF button
        document.getElementById('exportPdfBtn').addEventListener('click', async function() {
            await exportToPDF();
        });

        // Export map to PDF
        async function exportToPDF() {
            const btn = document.getElementById('exportPdfBtn');
            btn.textContent = 'PDF maken...';
            btn.disabled = true;

            try {
                // Get the map container
                const mapElement = document.getElementById('map');
                
                // Capture the map as canvas
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    scale: 2 // Higher quality
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Calculate dimensions to fit A4
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20; // 10mm margins
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 10;
                
                // Add title
                pdf.setFontSize(16);
                pdf.text('Windturbine Visualisatie - Hoeker en GarstenPolder', pdfWidth / 2, position, { align: 'center' });
                position += 10;
                
                // Add date
                pdf.setFontSize(10);
                const dateStr = new Date().toLocaleDateString('nl-NL', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                pdf.text(`Datum: ${dateStr}`, pdfWidth / 2, position, { align: 'center' });
                position += 10;
                
                // Add map image
                if (imgHeight > pdfHeight - position - 10) {
                    // Scale down if too tall
                    const scale = (pdfHeight - position - 10) / imgHeight;
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth * scale, imgHeight * scale);
                } else {
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                }
                
                position += Math.min(imgHeight, pdfHeight - position - 10) + 10;
                
                // Add turbine details on new page if needed
                if (turbines.length > 0) {
                    pdf.addPage();
                    position = 20;
                    
                    pdf.setFontSize(14);
                    pdf.text('Turbine Details', 10, position);
                    position += 10;
                    
                    pdf.setFontSize(10);
                    const colorNames = ['Klein', 'Middelgroot', 'Groot'];
                    turbines.forEach((turbine, idx) => {
                        pdf.text(`Turbine ${idx + 1}: ${colorNames[turbine.typeIndex]} (${turbine.type.name})`, 10, position);
                        position += 5;
                        pdf.text(`  Locatie: ${turbine.latlng.lat.toFixed(6)}, ${turbine.latlng.lng.toFixed(6)}`, 10, position);
                        position += 5;
                        pdf.text(`  Ashoogte: ${turbine.type.hubHeight}m, Tiphoogte: ${turbine.type.hubHeight + turbine.type.rotorDiameter/2}m`, 10, position);
                        position += 8;
                        
                        if (position > pdfHeight - 20) {
                            pdf.addPage();
                            position = 20;
                        }
                    });
                    
                    // Add statistics if available
                    if (affectedAddresses.length > 0) {
                        position += 5;
                        pdf.setFontSize(14);
                        pdf.text(`Woningen binnen ${hinderDistance}m`, 10, position);
                        position += 10;
                        
                        pdf.setFontSize(10);
                        pdf.text(`Totaal aantal woningen: ${affectedAddresses.length}`, 10, position);
                    }
                }
                
                // Save PDF
                const filename = `windturbine-visualisatie-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);
                
                alert('PDF succesvol ge√´xporteerd!');
                
            } catch (error) {
                console.error('PDF export fout:', error);
                alert('Fout bij PDF export: ' + error.message);
            } finally {
                btn.textContent = 'üìÑ Export PDF';
                btn.disabled = false;
            }
        }

        // Analyze affected addresses using uploaded CSV
        function analyzeAffectedAddresses() {
            affectedAddresses = [];
            
            const statsContent = document.getElementById('statsContent');
            const statsResults = document.getElementById('statsResults');
            
            // Show progress
            statsContent.innerHTML = '<p class="text-gray-600">Bezig met analyseren...</p>';
            statsResults.classList.remove('hidden');
            
            console.log(`Analyseren met ${uploadedAddresses.length} adressen`);
            
            // For each turbine, filter addresses within range
            const turbineStats = [];
            
            for (let i = 0; i < turbines.length; i++) {
                const turbine = turbines[i];
                const turbineLatlng = turbine.marker.getLatLng();
                
                console.log(`Analyseren turbine ${i + 1} op positie:`, turbineLatlng.lat, turbineLatlng.lng);
                
                const nearbyAddresses = uploadedAddresses.filter(addr => {
                    const distance = calculateDistance(
                        { lat: turbineLatlng.lat, lng: turbineLatlng.lng },
                        { lat: addr.lat, lng: addr.lng }
                    );
                    
                    return distance <= hinderDistance;
                }).map(addr => {
                    const distance = Math.round(calculateDistance(
                        { lat: turbineLatlng.lat, lng: turbineLatlng.lng },
                        { lat: addr.lat, lng: addr.lng }
                    ));
                    
                    return {
                        address: addr.address,
                        postcode: addr.postcode,
                        huisnummer: addr.huisnummer || '',
                        woonplaats: addr.woonplaats || '',
                        lat: addr.lat,
                        lng: addr.lng,
                        distance,
                        turbineIndex: i,
                        turbineName: `Turbine ${i + 1}`
                    };
                });
                
                console.log(`Turbine ${i + 1}: ${nearbyAddresses.length} woningen binnen ${hinderDistance}m`);
                
                turbineStats.push({
                    turbineIndex: i,
                    count: nearbyAddresses.length,
                    addresses: nearbyAddresses
                });
                
                // Add to global list (avoiding duplicates)
                nearbyAddresses.forEach(addr => {
                    if (!affectedAddresses.find(a => a.address === addr.address)) {
                        affectedAddresses.push(addr);
                    }
                });
            }
            
            console.log(`Totaal aantal unieke adressen binnen ${hinderDistance}m: ${affectedAddresses.length}`);
            
            displayStatistics(turbineStats);
        }
        
        // Helper function to display statistics
        function displayStatistics(turbineStats) {
            const statsContent = document.getElementById('statsContent');
            const statsResults = document.getElementById('statsResults');
            
            // Display statistics
            let html = `<p class="mb-2"><strong>Totaal: ${affectedAddresses.length} woningen</strong> binnen ${hinderDistance}m</p>`;
            
            if (turbineStats.length > 0) {
                html += '<div class="text-xs space-y-1 mb-2">';
                turbineStats.forEach((stat, idx) => {
                    const colorIndicators = ['üü¢', 'üü†', 'üî¥'];
                    html += `<p>${colorIndicators[turbines[stat.turbineIndex].typeIndex]} Turbine ${stat.turbineIndex + 1}: ${stat.count} woningen</p>`;
                });
                html += '</div>';
            }
            
            if (affectedAddresses.length === 0) {
                html += '<p class="text-gray-600 text-xs">Geen woningen gevonden binnen deze afstand. Probeer een grotere afstand of controleer of turbines in het juiste gebied staan.</p>';
            } else {
                // Show some example addresses
                html += '<div class="text-xs mt-2 p-2 bg-gray-50 rounded max-h-40 overflow-y-auto">';
                html += '<p class="font-semibold mb-1">Voorbeeldadressen:</p>';
                const examples = affectedAddresses.slice(0, 10).sort((a, b) => a.distance - b.distance);
                examples.forEach(addr => {
                    html += `<p class="text-xs">‚Ä¢ ${addr.address} (${addr.distance}m)</p>`;
                });
                if (affectedAddresses.length > 10) {
                    html += `<p class="text-xs text-gray-500 mt-1">... en ${affectedAddresses.length - 10} meer</p>`;
                }
                html += '</div>';
            }
            
            statsContent.innerHTML = html;
            statsResults.classList.remove('hidden');
        }

        // Export address list to CSV
        function exportAddressList() {
            if (affectedAddresses.length === 0) {
                alert('Geen adressen om te exporteren. Voer eerst een analyse uit.');
                return;
            }
            
            // Sort by distance
            const sorted = [...affectedAddresses].sort((a, b) => a.distance - b.distance);
            
            // Create CSV content
            let csv = 'Adres,Postcode,Huisnummer,Woonplaats,Afstand (m),Dichtstbijzijnde Turbine,Latitude,Longitude\n';
            
            sorted.forEach(addr => {
                csv += `"${addr.address}","${addr.postcode}","${addr.huisnummer}","${addr.woonplaats}",${addr.distance},"${addr.turbineName}",${addr.lat},${addr.lng}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `windturbine-adressen-binnen-${hinderDistance}m.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`${affectedAddresses.length} adressen ge√´xporteerd naar CSV bestand!`);
        }

        // Address search
        async function searchAddress() {
            const postcode = document.getElementById('postcode').value.replace(/\s/g, '').toUpperCase();
            const huisnummer = document.getElementById('huisnummer').value;
            const errorEl = document.getElementById('searchError');
            const btn = document.getElementById('searchBtn');

            if (!postcode || !huisnummer) {
                errorEl.textContent = 'Vul postcode en huisnummer in';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.textContent = 'Zoeken...';
            btn.disabled = true;
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(
                    `https://api.pdok.nl/bzk/locatieserver/search/v3_1/free?q=${postcode}+${huisnummer}&fq=type:adres`
                );
                
                const data = await response.json();
                
                console.log('API Response:', data); // Debug
                
                if (data.response.docs.length > 0) {
                    const result = data.response.docs[0];
                    
                    console.log('Result object:', result); // Debug
                    
                    // Parse POINT geometry from centroide_ll
                    let lat, lng;
                    
                    if (result.centroide_ll) {
                        // Format is "POINT(lng lat)"
                        const match = result.centroide_ll.match(/POINT\(([^ ]+) ([^ ]+)\)/);
                        if (match) {
                            lng = parseFloat(match[1]);
                            lat = parseFloat(match[2]);
                        }
                    }
                    
                    console.log('Parsed coordinates:', { lat, lng }); // Debug
                    
                    // Validate coordinates
                    if (isNaN(lat) || isNaN(lng)) {
                        console.error('Invalid coordinates after parsing'); // Debug
                        throw new Error('Ongeldige co√∂rdinaten ontvangen van PDOK API');
                    }
                    
                    // Sanity check for Netherlands coordinates
                    if (lat < 50 || lat > 54 || lng < 3 || lng > 8) {
                        throw new Error('Co√∂rdinaten lijken niet in Nederland te liggen');
                    }
                    
                    console.log('Gevonden co√∂rdinaten:', lat, lng); // Debug
                    
                    const latlng = L.latLng(lat, lng);
                    
                    map.flyTo(latlng, 16);

                    if (searchedAddressMarker) {
                        searchedAddressMarker.remove();
                    }

                    searchedAddressMarker = L.marker(latlng).addTo(map);
                    searchedAddressMarker.bindPopup(`
                        <div class="text-sm">
                            <p class="font-semibold">${result.weergavenaam}</p>
                        </div>
                    `).openPopup();

                    // Store coordinates as plain object
                    searchedAddress = {
                        latlng: { lat: lat, lng: lng },
                        address: result.weergavenaam,
                        postcode,
                        huisnummer
                    };

                    console.log('Opgeslagen adres:', searchedAddress); // Debug

                    updateAddressAnalysis();
                } else {
                    errorEl.textContent = 'Adres niet gevonden';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Fout:', err); // Debug
                errorEl.textContent = 'Fout bij zoeken: ' + err.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.textContent = 'Zoek';
                btn.disabled = false;
            }
        }

        document.getElementById('searchBtn').addEventListener('click', searchAddress);
        document.getElementById('postcode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });
        document.getElementById('huisnummer').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAddress();
        });

        // Calculate distance between two points
        function calculateDistance(latlng1, latlng2) {
            const R = 6371e3; // Earth radius in meters
            
            // Handle both Leaflet LatLng objects and plain objects
            const lat1 = latlng1.lat || latlng1.latitude;
            const lng1 = latlng1.lng || latlng1.longitude;
            const lat2 = latlng2.lat || latlng2.latitude;
            const lng2 = latlng2.lng || latlng2.longitude;
            
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Update address analysis
        function updateAddressAnalysis() {
            const analysisDiv = document.getElementById('addressAnalysis');
            
            if (!searchedAddress || turbines.length === 0) {
                analysisDiv.classList.add('hidden');
                return;
            }

            console.log('Analyseer adres:', searchedAddress.latlng); // Debug
            console.log('Aantal turbines:', turbines.length); // Debug

            const distances = turbines.map((turbine, idx) => {
                console.log(`Turbine ${idx}:`, turbine.latlng); // Debug
                const dist = calculateDistance(searchedAddress.latlng, turbine.latlng);
                console.log(`Afstand tot turbine ${idx}:`, dist); // Debug
                return dist;
            });

            const minDistance = Math.min(...distances);
            const roundedDistance = Math.round(minDistance);

            console.log('Minimale afstand:', roundedDistance); // Debug

            document.getElementById('addressName').textContent = searchedAddress.address;
            document.getElementById('addressDistance').innerHTML = 
                `Dichtstbijzijnde turbine: <strong>${roundedDistance}m</strong>`;

            let zoneText = '';
            if (roundedDistance < 500) {
                zoneText = '‚ö†Ô∏è Binnen 500m zone';
            } else if (roundedDistance < 1000) {
                zoneText = '‚ö†Ô∏è Binnen 1km zone';
            } else if (roundedDistance < 1500) {
                zoneText = 'Binnen 1.5km zone';
            } else if (roundedDistance < 2000) {
                zoneText = 'Binnen 2km zone';
            } else {
                zoneText = '‚úì Buiten 2km zone';
            }

            document.getElementById('addressZone').textContent = zoneText;
            analysisDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
